# 项目改进路线与落地建议

## 第一阶段：服务化与时间索引（优先级：高）
- [x] 提供 HTTP/REST 接口：`/health`、`/query`、`/stats`，响应结构化 JSON。
- [x] 封装现有查询链路（`CmdManager`/`LogDispatcher`/`LogStoreApi`）为服务层，支持按目录加载与单次请求按需加载。
- [x] 引入时间列与范围过滤基元：压缩阶段抽取 `timestamp` 写入独立列；查询支持时间窗口过滤与分段路由。
- [x] 段管理与按需解压：按时间切片输出，查询端仅载入命中段的元信息与数据，降低冷启动与内存占用。

## 第二阶段：索引增强与聚合能力（优先级：中高）
- 位图压缩与布尔优化：引入压缩位图变体（如 Roaring），降低组合成本，兼容现有接口。
- 字典索引扩展：为 `.dic/.entry` 增加前缀/后缀/三元组索引层，提升部分匹配与正则性能。
- 聚合与统计 API：在 `StatisticsAPI` 基础上实现 `count/sum/avg/min/max`、`group by`、`percentile`（t-digest）、`cardinality`（HLL）。
- 时间序列分析：提供 `histogram/timechart` 基元，与时间列结合实现窗口聚合。

## 第三阶段：数据摄入与生态（优先级：中）
- [x] 轻量数据代理：文件/目录监控、stdin 流、HTTP/Kafka 入口，滚动写入压缩段，批量策略与落盘回收。
- 字段提取与增强：可插拔解析器与丰富器（lookup、geoip 等），压缩前标准化与归一化。
- 兼容查询适配：DSL 设计覆盖 `term/regex/range/time/agg`；提供 ES DSL/SPL 子集映射，便于迁移。

## 第四阶段：运维、安全与生命周期（优先级：中）
- 权限与租户：查询 token/RBAC，按路径/段控制访问。
- 生命周期管理：热/温/冷分层与 ILM 策略，自动滚动与归档、过期段清理。
- 监控与指标：暴露查询耗时、解压字节、材料化行数、段加载情况等指标，用于容量与性能评估。

## 与 Elasticsearch/Splunk 对比的差距与方向
- 架构形态：当前为单机 CLI；目标演进为服务形态，逐步引入分段管理与近实时查询，再推进分布式。
- 索引模型：当前列式+位图推下；补齐时间维度与聚合算子，增强字典索引，提升部分匹配能力。
- 查询语言：从轻量 DSL 起步，逐步适配 ES/SPL 子集；完善布尔、范围、聚合与管道式表达。
- 生态与摄入：补齐 agent/connector 与 enrichment，形成标准化入口与数据治理。

## 近期里程碑与交付
- [x] 里程碑 M1（服务化最小可用）：HTTP 服务可查询，返回 JSON 统计与基础结果，支持健康检查。
- [x] 里程碑 M2（时间索引与分段）：压缩写入时间列，查询支持时间过滤，按需解压段级数据。
- [ ] 里程碑 M3（索引与聚合）：压缩位图、字典索引增强，基础聚合能力与时间直方图。
- [ ] 里程碑 M4（摄入与权限）：轻量 agent、权限控制与监控指标，形成可运维形态。

## 实施建议
- 服务层复用现有 `LogDispatcher` 与 `LogStoreApi` 查询与材料化能力，先提供统计结果 JSON；日志内容 JSON 逐步接入。
- 代码内按模块扩展：服务入口独立文件与构建目标；`LogDispatcher` 增加统计获取接口；`LogStoreApi` 维持查询路径稳定。
- 按需加载与资源限制：限制单次材料化上限与分页，控制最大解压尺寸与内存占用，提升稳定性。

